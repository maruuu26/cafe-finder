<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cafe Curator</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òïÔ∏è</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Savate:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <link rel="stylesheet" href="styles.css">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_lAimk3FvmcHLm_2DYUYE6y5MKNThG10&libraries=places"></script>
</head>
<body>
  <h1>‚òïÔ∏è Cafe Curator üçµ</h1>
  <p>Find and save the best cafes near you.</p>

  <div id="controls">
    <button onclick="getLocationCachedOrNew()">Find Cafes Near Me</button>
    <button onclick="showSaved()">Show Saved Cafes</button>
  </div>

  <div class="cards">
    <p id="initial-message">Click "Find Cafes Near Me" or wait for location request...</p>
  </div>

  <script>
    // Constants
    const CACHE_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes

    function getLocationCachedOrNew() {
      const container = document.querySelector('.cards');
      const initialMessage = document.getElementById('initial-message');
      
      // Clear previous messages/cards
      if (initialMessage) initialMessage.textContent = 'Searching...';
      container.innerHTML = initialMessage ? '' : '<p>Searching...</p>';

      const cache = JSON.parse(localStorage.getItem('cachedLocation') || '{}');
      const now = Date.now();
      
      // 1. Check Cache
      if (cache.timestamp && now - cache.timestamp < CACHE_TIMEOUT_MS) {
        console.log("Using cached location.");
        useLocation(cache.lat, cache.lng);
      } else {
        // 2. Request New Location
        console.log("Requesting new location from browser...");
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          localStorage.setItem('cachedLocation', JSON.stringify({ lat, lng, timestamp: now }));
          useLocation(lat, lng);
        }, (error) => {
          // Geolocation Error Handling
          const errorMessage = "Location access denied or unavailable. " + error.message;
          console.error(errorMessage, error);
          container.innerHTML = `<p class="error-message">${errorMessage}</p>`;
        });
      }
    }

    function useLocation(lat, lng) {
      // Create a hidden map element (required by PlacesService)
      const map = new google.maps.Map(document.createElement('div'));
      const service = new google.maps.places.PlacesService(map);

      const request = {
        location: new google.maps.LatLng(lat, lng),
        radius: 1500, // 1500 meters (~0.93 miles)
        type: ['cafe']
      };
      
      console.log(`Searching for cafes around Lat: ${lat}, Lng: ${lng}`);

      service.nearbySearch(request, (results, status) => {
        const container = document.querySelector('.cards');
        container.innerHTML = ''; // Clear 'Searching...' message

        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
          console.log(`Successfully found ${results.length} cafes.`);
          displayCards(results);
        } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
          console.warn("Google Places Status: ZERO_RESULTS. No cafes found nearby.");
          container.innerHTML = '<p>No cafes found within 1.5 km of your location üò¢</p>';
        } else {
          // Catch API errors (e.g., REQUEST_DENIED due to API key issues)
          console.error("Google Places API Error Status:", status);
          container.innerHTML = `<p class="error-message">Error finding cafes: ${status}. Check your API key and network console.</p>`;
        }
      });
    }

    function displayCards(cafes) {
      const container = document.querySelector('.cards');
      
      cafes.forEach((cafe, i) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'swipe-wrapper';
        wrapper.style.zIndex = 200 - i;

        const card = document.createElement('div');
        card.className = 'location-card';

        // Safely get photo URL
        const photo = cafe.photos && cafe.photos[0];
        const imgUrl = photo ? photo.getUrl({ maxWidth: 400 }) : 'https://via.placeholder.com/250x150?text=No+Image';

        const cafeData = {
          name: cafe.name,
          place_id: cafe.place_id,
          photo: imgUrl,
          rating: cafe.rating || 'N/A'
        };

        card.innerHTML = `
          <img src="${imgUrl}" alt="${cafe.name}" />
          <h3>${cafe.name}</h3>
          <p>‚≠êÔ∏è Rating: ${cafe.rating || 'N/A'}</p>
          <p><small>Swipe right to save üíñ</small></p>
        `;

        wrapper.appendChild(card);
        container.appendChild(wrapper);

        const hammertime = new Hammer(wrapper);
        hammertime.on('swipeleft', () => {
          wrapper.style.transform = 'translateX(-150%) rotate(-15deg)';
          wrapper.style.opacity = 0;
          setTimeout(() => wrapper.remove(), 100);
        });
        hammertime.on('swiperight', () => {
          saveCafe(cafeData); // Pass object directly, no need for JSON stringify here
          wrapper.style.transform = 'translateX(150%) rotate(15deg)';
          wrapper.style.opacity = 0;
          setTimeout(() => wrapper.remove(), 100);
        });
      });
    }

    function saveCafe(cafe) { // Function signature changed to accept object
      let saved = JSON.parse(localStorage.getItem('savedCafes') || '[]');
      if (!saved.find(c => c.place_id === cafe.place_id)) {
        saved.push(cafe);
        localStorage.setItem('savedCafes', JSON.stringify(saved));
        console.log(`${cafe.name} saved!`);
      } else {
        console.warn(`${cafe.name} is already saved.`);
      }
    }

    function showSaved() {
      const container = document.querySelector('.cards');
      container.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem('savedCafes') || '[]');
      
      if (saved.length === 0) {
        container.innerHTML = '<p>No saved cafes yet üò¢</p>';
        return;
      }
      
      // Displaying saved cafes (similar to displayCards, but without swipe logic)
      saved.forEach(cafe => {
        const card = document.createElement('div');
        card.className = 'location-card';
        card.innerHTML = `
          <img src="${cafe.photo}" alt="${cafe.name}" />
          <h3>${cafe.name}</h3>
          <p>‚≠êÔ∏è Rating: ${cafe.rating}</p>
        `;
        container.appendChild(card);
      });
    }

    // ‚≠ê KEY FIX/IMPROVEMENT: Try to load cafes when the page is ready
    window.onload = function() {
        // We wrap this in a timeout to ensure the Google Maps API has fully loaded (latency issue)
        setTimeout(() => {
             getLocationCachedOrNew();
        }, 100); 
    };
  </script>
</body>
</html>